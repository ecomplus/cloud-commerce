---
import { resolve as resolvePath } from 'node:path';
import { getImage } from 'astro:assets';
import imageSize from 'image-size';
import { createPictureGetter } from '../../images/picture-base';
import { type PictureProps, useSSRPicture } from '../../images/use-ssr-picture';

export type Props = PictureProps;

const deployRand = import.meta.env.DEPLOY_RAND;
const versionSuffix = import.meta.env.BUILD_OUTPUT !== 'static' && deployRand
  ? `&V=${deployRand}`
  : '';

const getImageFilepath = (src: string) => {
  return resolvePath(import.meta.env.STOREFRONT_BASE_DIR, `public${src}`);
};
const tryImageSize = (src: string) => {
  let dimensions: { width?: number, height?: number } = {};
  if (typeof src === 'string' && src.startsWith('/')) {
    try {
      dimensions = imageSize(getImageFilepath(src));
    } catch (e) {
      dimensions = {};
    }
  }
  return dimensions;
};

const {
  sizes,
  sources,
  pictureAttrs,
  imgAttrs,
} = await useSSRPicture({
  ...Astro.props,
  tryImageSize,
  getPicture: createPictureGetter(async (imageOptions) => {
    const {
      options,
      src,
      attributes: { width, height },
    } = await getImage(imageOptions);
    return { src, width, height };
  }),
});
if (imgAttrs) {
  imgAttrs.src += versionSuffix;
}
---

<picture {...pictureAttrs}>
  {sources.map((attrs) => {
    if (versionSuffix) {
      attrs.srcset = attrs.srcset.replace(/\s(\w+)$/, `${versionSuffix} $1`);
    }
    return <source {...attrs} sizes={sizes} />
  })}
  {imgAttrs && <img {...imgAttrs} />}
</picture>

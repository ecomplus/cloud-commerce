---
import { Head } from 'astro-capo';
import BaseBody from '@@sf/layouts/BaseBody.astro';

const { getContent } = Astro.locals.routeContext;
const { customCode } = await getContent('layout');
---

<Head>
  <slot name="base-head" />
  {customCode?.css && <style>{customCode.css}</style>}
  {customCode?.htmlHead && <Fragment set:html={customCode.htmlHead} />}
  <slot name="base-head-scripts">
    <script src="../scripts/modules-info-preset"></script>
  </slot>
  <slot name="before-head-end" />
</Head>
<BaseBody>
  <slot />
  {customCode?.htmlBody && <Fragment set:html={customCode.htmlBody} />}
  <slot name="base-body-scripts">
    <script src="../scripts/session-utm"></script>
    <script src="../scripts/push-analytics-events"></script>
    <script>
      /* eslint-disable */
      import { prefetch } from 'astro:prefetch';
      window.$prefetch = prefetch;
      const raceAndLoadScripts = () => Promise.race([
        window.$firstInteraction,
        new Promise((resolve) => { setTimeout(resolve, 4000); }),
      ]).then(() => {
        const loadDelayedScripts = () => {
          window.$delayedAsyncScripts?.forEach((src) => {
            const script = document.createElement('script');
            script.async = true;
            script.src = src;
            document.body.appendChild(script);
          });
        };
        setTimeout(() => {
          if (typeof window.requestIdleCallback === 'function') {
            window.requestIdleCallback(loadDelayedScripts);
            return;
          }
          loadDelayedScripts();
        }, 500);
      });
      if (document.readyState !== 'loading') {
        raceAndLoadScripts();
      } else {
        document.addEventListener('DOMContentLoaded', () => {
          setTimeout(raceAndLoadScripts, 50);
        });
      }
    </script>
  </slot>
  <slot name="before-body-end" />
</BaseBody>

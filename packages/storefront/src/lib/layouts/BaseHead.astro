---
import type { PageContext } from '@@sf/ssr-context';
import { pwaInfo } from 'virtual:pwa-info';
import { img as getImg } from '@ecomplus/utils';

export interface Props {
  pageContext: PageContext;
  title?: string;
}

const {
  storeId,
  cmsContent,
  apiDoc,
  lang,
  domain,
  primaryColor,
  settings,
  cms,
} = Astro.props.pageContext;
const state = apiDoc || cmsContent || {};
const title = state.meta_title || state.name || state.title || Astro.props.title || settings.name;
const description = state.meta_description || state.short_description || settings.description;
const favicon = settings.icon
  ? '/_image?f=png&w=32&h=32&format=png'
    + `&href=${encodeURIComponent(settings.icon)}&V=${import.meta.env.DEPLOY_RAND}`
  : '/favicon.ico';
const canonicalUrl = new URL(Astro.url.pathname, Astro.site || `https://${domain}`);
const cmsMetatags = await cms('metatags');
const ogLocale = lang.length === 2 ? lang : lang.substring(0, 2) + lang.slice(3).toUpperCase();
let ogImage: string | undefined;
if (apiDoc) {
  const picture = getImg(state, null, 'zoom');
  ogImage = picture && picture.url;
}
if (!ogImage) {
  if (cmsMetatags?.og_image) {
    ogImage = cmsMetatags.og_image.charAt(0) === '/'
      ? `https://${domain}${cmsMetatags.og_image}` : cmsMetatags.og_image;
  }
} else {
  ogImage = ogImage.replace(/(\w+\.)?(ecoms\d)\.com/i, '$2-nyc3.nyc3.cdn.digitaloceanspaces.com');
}
---

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content={primaryColor}>
<link rel="icon" href={favicon} />
<title>{title}</title>
<meta name="description" content={description}>
<meta name="author" content={settings.name}>
<meta name="generator" content={Astro.generator} />
<link rel="canonical" href={canonicalUrl} />
<link rel="apple-touch-icon" href={settings.icon} />
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta property="og:site_name" content={settings.name}>
<meta property="og:url" content={canonicalUrl}>
<meta property="og:title" content={title}>
<meta property="og:description" content={description}>
<meta property="og:type" content="website">
<meta property="og:locale" content={ogLocale}>
{ogImage && <meta property="og:image" content={ogImage} />}
{cmsMetatags?.fb_app_id && <meta property="fb:app_id" content={cmsMetatags.fb_app_id} />}
<meta name="twitter:card" content="summary">
{cmsMetatags?.twitter_username &&
  <meta name="twitter:site" content={cmsMetatags.twitter_username} />}
<meta name="ecom-store-id" content={String(storeId)}>
<script>
  import { registerSW } from 'virtual:pwa-register';
  registerSW({ immediate: true });
</script>
{pwaInfo && <Fragment set:html={pwaInfo.webManifest.linkTag} />}
{(!pwaInfo && !import.meta.env.DEV) &&
  <link rel="manifest" href="/manifest.webmanifest" />}

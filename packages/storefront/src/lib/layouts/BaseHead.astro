---
import { pwaInfo } from 'virtual:pwa-info';
import { img as getImg, price as getPrice } from '@ecomplus/utils';

const deployRand = import.meta.env.DEPLOY_RAND || '_';
const getIconUrl = (size: number) => {
  return `/_image?f=png&w=${size}&h=${size}`
    + `&href=${encodeURIComponent(settings.icon)}&V=${deployRand}`;
};

const {
  storeId,
  cmsContent,
  fetchingApiContext,
  apiContext,
  lang,
  countryCode,
  currency,
  currencySymbol,
  domain,
  primaryColor,
  settings,
  isPreview,
  getContent,
} = Astro.locals.routeContext;
if (fetchingApiContext) {
  await fetchingApiContext;
}

const apiDoc = apiContext.doc;
const state: Record<string, any> = apiDoc || cmsContent || {};
const title = state.meta_title || state.name || state.title || settings.name;
const description = state.meta_description || state.short_description || settings.description;
const favicon = settings.icon ? getIconUrl(32) : '/favicon.ico';
const shortcutIcon = settings.icon ? getIconUrl(192) : null;
const canonicalUrl = new URL(Astro.url.pathname, Astro.site || `https://${domain}`);
const { metatags: metatagsContent } = await getContent('layout');
const ogLocale = lang.length === 2 ? lang : lang.substring(0, 2) + lang.slice(3).toUpperCase();
let ogImage: string | undefined;
if (apiDoc) {
  const picture = getImg(state, undefined, 'zoom');
  ogImage = picture && picture.url;
}
if (!ogImage) {
  if (metatagsContent?.og_image) {
    ogImage = metatagsContent.og_image.charAt(0) === '/'
      ? `https://${domain}${metatagsContent.og_image}` : metatagsContent.og_image;
  }
} else {
  ogImage = ogImage.replace(/(\w+\.)?(ecoms\d)\.com/i, '$2-nyc3.nyc3.cdn.digitaloceanspaces.com');
}

let inlineClientJS = `
window.ECOM_STORE_ID = ${storeId};
window.ECOM_LANG = '${lang}';
window.ECOM_CURRENCY = '${currency}';
window.ECOM_CURRENCY_SYMBOL = '${currencySymbol}';
window.ECOM_COUNTRY_CODE = '${countryCode}';
window.$storefront = ${JSON.stringify({ settings, data: {} })};`;
if (apiContext.error) {
  const { message, statusCode } = apiContext.error;
  const url = Astro.url.pathname;
  inlineClientJS += `
console.error(${JSON.stringify(message)});
setTimeout(() => {
  window.location.replace("/~fallback?status=${statusCode}&url=${encodeURIComponent(url)}");
}, 1);`;
}
if (apiDoc) {
  if (typeof apiDoc.price === 'number') {
    apiDoc.price = getPrice(apiDoc);
  }
  const slimDocRegex = globalThis.$storefrontSlimDocRegex
    || /body_|meta_|metafields|_records|i18n/;
  const minifyApiDoc = (nestedDoc: any) => {
    if (typeof nestedDoc === 'object' && nestedDoc) {
      if (Array.isArray(nestedDoc)) {
        nestedDoc.forEach((item) => minifyApiDoc(item));
      } else {
        Object.keys(nestedDoc).forEach((field) => {
          if (slimDocRegex.test(field)) {
            delete nestedDoc[field];
          } else {
            minifyApiDoc(nestedDoc[field]);
          }
        });
      }
    }
    return nestedDoc;
  };
  inlineClientJS += `
window.$storefront.apiContext = ${JSON.stringify({
  resource: apiContext.resource,
  doc: minifyApiDoc({ ...apiDoc }),
  timestamp: Date.now(),
})};
window.$storefront.context /* DEPRECATED */ = window.$storefront.apiContext`;
}
if (isPreview) {
  inlineClientJS += `
window.$isCmsPreview = true;`;
}

const inlineJSONLd = JSON.stringify({
  '@context': 'http://schema.org',
  '@type': 'Organization',
  name: settings.name,
  url: `https://${domain}/`,
  logo: `https://${domain}${settings.logo}`,
});
---

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content={primaryColor}>
<link rel="icon" type="image/png" href={favicon} sizes="32x32" />
{shortcutIcon &&
  <link rel="icon" type="image/png" href={shortcutIcon} sizes="192x192" />}
<title>{title}</title>
<meta name="description" content={description}>
<meta name="author" content={settings.name}>
<meta name="generator" content={Astro.generator} />
<link rel="canonical" href={canonicalUrl} />
{shortcutIcon && <link rel="apple-touch-icon" href={shortcutIcon} />}
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta property="og:site_name" content={settings.name}>
<meta property="og:url" content={canonicalUrl}>
<meta property="og:title" content={title}>
<meta property="og:description" content={description}>
<meta property="og:type" content="website">
<meta property="og:locale" content={ogLocale}>
{ogImage && <meta property="og:image" content={ogImage} />}
{metatagsContent?.fb_app_id &&
  <meta property="fb:app_id" content={metatagsContent.fb_app_id} />}
<meta name="twitter:card" content="summary">
{metatagsContent?.twitter_username &&
  <meta name="twitter:site" content={metatagsContent.twitter_username} />}
<meta name="ecom-store-id" content={String(storeId)}>

<script>
  import { registerSW } from 'virtual:pwa-register';
  registerSW({ immediate: false });
</script>
{pwaInfo && <Fragment set:html={pwaInfo.webManifest.linkTag} />}
{(!pwaInfo && !import.meta.env.DEV) &&
  <link rel="manifest" href="/manifest.webmanifest" />}

<script is:inline set:html={inlineClientJS} />
<script type="application/ld+json" set:html={inlineJSONLd} />

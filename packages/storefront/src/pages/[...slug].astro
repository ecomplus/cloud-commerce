---
import loadPageContext, { PageContext } from '../lib/ssr-context';
import api from '@cloudcommerce/api';
import PagesLayout from '../lib/layouts/Pages.astro';
import WildcardMain from '../lib/main/Wildcard.astro';

if (String(Astro.params.slug).endsWith('.css.map')) {
  return new Response(null, { status: 404 });
}

let pageContext: PageContext;
let loadError: any;
try {
  pageContext = await loadPageContext(Astro);
} catch (err) {
  if (err.astroResponse) {
    return err.astroResponse;
  }
  loadError = err;
}

export async function getStaticPaths() {
  return (await api.get('products?sort=-sales&limit=4&fields=slug'))
    .data.result.map(({ slug }) => ({ params: { slug } }));
}
---

<!DOCTYPE html>
<html lang={pageContext?.lang.replace('_', '-')}>
{pageContext &&
  <PagesLayout pageContext={pageContext}>
    <WildcardMain pageContext={pageContext} />
  </PagesLayout>
}
{loadError && <Fragment set:html={loadError.responseHTML} />}
</html>
